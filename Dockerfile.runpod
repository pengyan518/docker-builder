# Dockerfile.runpod
# ä¼˜åŒ–çš„ RunPod Serverless é•œåƒ
# 
# ç‰¹æ€§:
# 1. åŸºäº RunPod å®˜æ–¹ PyTorch é•œåƒ
# 2. é¢„å®‰è£… ComfyUI å’Œæ‰€æœ‰ä¾èµ–
# 3. ä¼˜åŒ–å±‚ç¼“å­˜ï¼Œå‡å°‘æ„å»ºæ—¶é—´
# 4. æ”¯æŒç½‘ç»œå­˜å‚¨å·æŒ‚è½½
# 5. æœ€å°åŒ–é•œåƒå¤§å°

FROM runpod/pytorch:2.4.0-py3.11-cuda12.4.1-devel-ubuntu22.04

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /workspace

# ===== ç¬¬ä¸€å±‚: ç³»ç»Ÿä¾èµ– =====
# è¿™ä¸€å±‚å¾ˆå°‘å˜åŒ–ï¼Œå¯ä»¥è¢«ç¼“å­˜
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    wget \
    curl \
    ca-certificates \
    libgl1-mesa-glx \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# ===== ç¬¬äºŒå±‚: ComfyUI å®‰è£… =====
# ComfyUI æœ¬èº«ä¸å¸¸æ›´æ–°ï¼Œå¯ä»¥ç¼“å­˜
RUN git clone https://github.com/comfyanonymous/ComfyUI.git /workspace/ComfyUI && \
    cd /workspace/ComfyUI && \
    pip install --no-cache-dir -r requirements.txt && \
    pip install --no-cache-dir \
        xformers \
        opencv-python \
        pillow

# ===== ç¬¬ä¸‰å±‚: åº”ç”¨ä¾èµ– =====
# å…ˆå¤åˆ¶ä¾èµ–æ–‡ä»¶ï¼Œåˆ©ç”¨ Docker ç¼“å­˜
COPY pyproject.toml /workspace/app/
COPY requirements_comfyui.txt /workspace/app/

WORKDIR /workspace/app

# å®‰è£… Python ä¾èµ–
RUN pip install --no-cache-dir \
    fastapi \
    uvicorn[standard] \
    runpod \
    httpx \
    websockets \
    supabase \
    boto3 \
    python-dotenv \
    pydantic \
    pydantic-settings \
    python-multipart

# ===== ç¬¬å››å±‚: åº”ç”¨ä»£ç  =====
# è¿™ä¸€å±‚æœ€å¸¸å˜åŒ–ï¼Œæ”¾åœ¨æœ€å
COPY app/ /workspace/app/app/
COPY core/ /workspace/app/core/
COPY runpod_handler.py /workspace/app/
COPY workflow/ /workspace/app/workflow/

# ===== ç¬¬äº”å±‚: ComfyUI è‡ªå®šä¹‰èŠ‚ç‚¹ï¼ˆå¯é€‰ï¼‰ =====
# å¦‚æœéœ€è¦ç‰¹å®šçš„è‡ªå®šä¹‰èŠ‚ç‚¹ï¼Œåœ¨è¿™é‡Œå®‰è£…
# RUN cd /workspace/ComfyUI/custom_nodes && \
#     git clone https://github.com/ltdrdata/ComfyUI-Manager.git

# ===== é…ç½® =====
# åˆ›å»ºå¿…è¦çš„ç›®å½•
RUN mkdir -p \
    /workspace/ComfyUI/models/checkpoints \
    /workspace/ComfyUI/models/vae \
    /workspace/ComfyUI/models/loras \
    /workspace/ComfyUI/models/embeddings \
    /workspace/ComfyUI/models/unet \
    /workspace/ComfyUI/models/clip \
    /workspace/ComfyUI/models/diffusion_models \
    /workspace/ComfyUI/models/text_encoders \
    /workspace/ComfyUI/models/controlnet \
    /workspace/ComfyUI/output \
    /workspace/ComfyUI/input \
    /runpod-volume/models

# è®¾ç½® ComfyUI ç¯å¢ƒå˜é‡
ENV COMFYUI_DIR=/workspace/ComfyUI \
    COMFYUI_MODEL_DIR=/workspace/ComfyUI/models \
    PYTHONPATH=/workspace/app:/workspace/ComfyUI

# ===== å¯é€‰: é¢„ä¸‹è½½çƒ­é—¨æ¨¡å‹ =====
# è¿™ä¼šæ˜¾è‘—å¢åŠ é•œåƒå¤§å°ï¼ˆæ¯ä¸ªæ¨¡å‹ 2-7GBï¼‰ï¼Œä½†å¯ä»¥å‡å°‘å†·å¯åŠ¨æ—¶é—´
# å»ºè®®åªé¢„è£… 1-2 ä¸ªæœ€å¸¸ç”¨çš„æ¨¡å‹
#
# æ–¹å¼1: ä» Hugging Face ä¸‹è½½
# RUN cd /workspace/ComfyUI/models/checkpoints && \
#     wget -O sd_xl_base_1.0.safetensors \
#     "https://huggingface.co/stabilityai/stable-diffusion-xl-base-1.0/resolve/main/sd_xl_base_1.0.safetensors"
#
# æ–¹å¼2: ä» R2 å¤åˆ¶ï¼ˆéœ€è¦åœ¨æ„å»ºæ—¶æä¾›å‡­è¯ï¼‰
# COPY scripts/preload_models.sh /tmp/
# RUN bash /tmp/preload_models.sh

# ===== å¥åº·æ£€æŸ¥ =====
# RunPod Serverless ä¸éœ€è¦æš´éœ²ç«¯å£ï¼Œä½†ä¿ç•™ç”¨äºè°ƒè¯•
EXPOSE 8188

# ===== å¯åŠ¨è„šæœ¬ =====
# åˆ›å»ºå¯åŠ¨è„šæœ¬ï¼Œå…ˆå¯åŠ¨ ComfyUIï¼Œå†å¯åŠ¨ RunPod handler
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "ğŸš€ Starting ComfyUI..."\n\
cd /workspace/ComfyUI\n\
python main.py --listen 0.0.0.0 --port 8188 &\n\
COMFYUI_PID=$!\n\
\n\
echo "â³ Waiting for ComfyUI to be ready..."\n\
for i in {1..30}; do\n\
    if curl -s http://localhost:8188/system_stats > /dev/null 2>&1; then\n\
        echo "âœ… ComfyUI is ready!"\n\
        break\n\
    fi\n\
    echo "Waiting... ($i/30)"\n\
    sleep 2\n\
done\n\
\n\
echo "ğŸ¯ Starting RunPod Serverless Handler..."\n\
cd /workspace/app\n\
python -u runpod_handler.py\n\
' > /start.sh && chmod +x /start.sh

# ===== è®¾ç½®å¯åŠ¨å‘½ä»¤ =====
CMD ["/start.sh"]

# ===== é•œåƒå…ƒæ•°æ® =====
LABEL maintainer="your-email@example.com" \
      description="RunPod Serverless ComfyUI Image Generation API" \
      version="1.0.0"

# ===== æ„å»ºè¯´æ˜ =====
# 
# æ„å»ºé•œåƒ:
#   docker build -f Dockerfile.runpod -t your-registry/comfyui-serverless:latest .
#
# æ¨é€åˆ° Docker Hub:
#   docker push your-registry/comfyui-serverless:latest
#
# æœ¬åœ°æµ‹è¯•:
#   docker run --rm -it \
#     -e SUPABASE_URL="your_url" \
#     -e SUPABASE_SERVICE_KEY="your_key" \
#     -e R2_ENDPOINT="your_endpoint" \
#     -e R2_ACCESS_KEY_ID="your_key" \
#     -e R2_SECRET_ACCESS_KEY="your_secret" \
#     -e R2_BUCKET_NAME="your_bucket" \
#     --gpus all \
#     your-registry/comfyui-serverless:latest
#
# ä¼˜åŒ–å»ºè®®:
# 1. ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºè¿›ä¸€æ­¥å‡å°é•œåƒå¤§å°
# 2. é¢„ä¸‹è½½ 1-2 ä¸ªæœ€å¸¸ç”¨æ¨¡å‹åˆ°é•œåƒä¸­
# 3. ä½¿ç”¨ .dockerignore æ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶
# 4. å®šæœŸæ›´æ–°åŸºç¡€é•œåƒä»¥è·å–å®‰å…¨è¡¥ä¸
